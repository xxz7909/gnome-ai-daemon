# 云厂商模型推荐与接入指南

适用目标：本机显存不足（如 2GB 笔记本），仅在本地运行 GNOME 控制层，模型推理走云端 API。

---

## 0. 本项目统一接入方式

本项目 `run_agent.py` 使用 OpenAI 兼容 `chat/completions` 协议，统一通过 3 个环境变量接入：

- `MODEL_API_BASE`：服务商 OpenAI 兼容根地址（通常以 `/v1` 结尾）
- `MODEL_API_KEY`：你的 API Key
- `MODEL_NAME`：多模态模型名（必须支持图像输入）

通用运行命令（实时模式）：

```bash
MODEL_API_BASE="<provider-base>" \
MODEL_API_KEY="<your-key>" \
MODEL_NAME="<vision-model>" \
.venv/bin/python run_agent.py --realtime --fps-interval 0.5 --cooldown 1.0 "打开终端并输入 hello world"
```

建议先确认本地控制层可用：

```bash
systemctl --user start gnome-ai-daemon
./scripts/verify_dbus.sh
./scripts/verify_api.sh
```

---

## 1. OpenRouter（推荐入门）

特点：

- 接入快、模型选择多、同一套 Key 可切换多个供应商模型
- 对个人开发者友好

配置模板：

```bash
export MODEL_API_BASE="https://openrouter.ai/api/v1"
export MODEL_API_KEY="<OPENROUTER_API_KEY>"
export MODEL_NAME="<OpenRouter上的多模态模型名>"
```

示例（请以控制台实际可用模型为准）：

```bash
MODEL_API_BASE="https://openrouter.ai/api/v1" \
MODEL_API_KEY="<OPENROUTER_API_KEY>" \
MODEL_NAME="openai/gpt-4.1-mini" \
.venv/bin/python run_agent.py --realtime "打开终端并输入 hello world"
```

连通性测试：

```bash
curl -s -H "Authorization: Bearer $MODEL_API_KEY" "$MODEL_API_BASE/models" | head
```

---

## 2. 阿里云百炼（DashScope 兼容模式）

特点：

- 国内网络稳定性通常更好
- 企业合规和权限管理更完整

配置模板（兼容模式）：

```bash
export MODEL_API_BASE="https://dashscope.aliyuncs.com/compatible-mode/v1"
export MODEL_API_KEY="<DASHSCOPE_API_KEY>"
export MODEL_NAME="<百炼支持的多模态模型名>"
```

示例（模型名以百炼控制台为准）：

```bash
MODEL_API_BASE="https://dashscope.aliyuncs.com/compatible-mode/v1" \
MODEL_API_KEY="<DASHSCOPE_API_KEY>" \
MODEL_NAME="qwen-vl-max" \
.venv/bin/python run_agent.py --realtime "打开终端并输入 hello world"
```

---

## 3. 火山引擎（ARK）

特点：

- 延迟和吞吐表现通常不错
- 常用于国内低时延场景

说明：ARK 常见做法是“模型接入点 ID（endpoint）”作为模型名使用。

配置模板：

```bash
export MODEL_API_BASE="https://ark.cn-beijing.volces.com/api/v3"
export MODEL_API_KEY="<ARK_API_KEY>"
export MODEL_NAME="<你的endpoint-id或模型名>"
```

示例（以你在火山控制台创建的 endpoint 为准）：

```bash
MODEL_API_BASE="https://ark.cn-beijing.volces.com/api/v3" \
MODEL_API_KEY="<ARK_API_KEY>" \
MODEL_NAME="ep-xxxxxxxxxxxxxxxx" \
.venv/bin/python run_agent.py --realtime "打开终端并输入 hello world"
```

---

## 4. 硅基流动（SiliconFlow）

特点：

- 开源模型覆盖广
- 接口简单，适合快速验证

配置模板：

```bash
export MODEL_API_BASE="https://api.siliconflow.cn/v1"
export MODEL_API_KEY="<SILICONFLOW_API_KEY>"
export MODEL_NAME="<硅基流动支持的多模态模型名>"
```

示例（模型名以平台文档/控制台为准）：

```bash
MODEL_API_BASE="https://api.siliconflow.cn/v1" \
MODEL_API_KEY="<SILICONFLOW_API_KEY>" \
MODEL_NAME="Qwen/Qwen2.5-VL-7B-Instruct" \
.venv/bin/python run_agent.py --realtime "打开终端并输入 hello world"
```

---

## 5. 推荐选择策略（你当前场景）

你目前“只有一台显存不足笔记本”，建议优先顺序：

1. **OpenRouter**：最快跑通、切模型方便
2. **阿里云百炼**：国内网络与稳定性优先
3. **火山 ARK**：低延迟需求优先
4. **硅基流动**：开源模型偏好、成本敏感

如果你只想先把流程打通，先用 OpenRouter；跑通后再迁移到成本更优平台。

---

## 6. 成本与稳定性优化

建议默认加上：

```bash
export SCREENSHOT_MAX_WIDTH=960
export SCREENSHOT_QUALITY=65
export IDLE_SKIP_THRESHOLD=0.03
```

效果：

- 降低图像上传体积，减少 API 费用
- 屏幕变化小就跳过推理，减少调用次数

---

## 7. 常见错误速查

1. `401 Unauthorized`
	- API Key 错误 / 过期 / 没有该模型权限

2. `404 Not Found`
	- `MODEL_API_BASE` 或 `MODEL_NAME` 不正确（尤其注意是否需要 `/v1`）

3. `429 Too Many Requests`
	- 触发限流；提高 `--fps-interval` 或减少实时模式调用频率

4. 模型可调用但动作不执行
	- 检查本地 daemon：`./scripts/verify_api.sh`
	- 检查扩展状态：`./scripts/verify_dbus.sh`

---

## 8. 复制即用的最小模板

```bash
systemctl --user start gnome-ai-daemon

MODEL_API_BASE="https://openrouter.ai/api/v1" \
MODEL_API_KEY="<OPENROUTER_API_KEY>" \
MODEL_NAME="<多模态模型名>" \
SCREENSHOT_MAX_WIDTH=960 \
SCREENSHOT_QUALITY=65 \
IDLE_SKIP_THRESHOLD=0.03 \
.venv/bin/python run_agent.py --realtime --fps-interval 0.5 --cooldown 1.0 "打开终端并输入 hello world"
```

> 注：各平台模型名、价格和可用区域会调整，请以服务商控制台最新信息为准。
